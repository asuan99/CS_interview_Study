### 질문. 데드락이란 무엇인가요?

---

**질문 답변**

운영체제에서 데드락(교착상태)이란, 시스템 자원에 대한 요구가 뒤엉킨 상태입니다.

즉, **둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황**을 일컫습니다.

- 동기화 문제란?
    - 동기화(Synchronization)
        
        프로세스들의 실행 순서를 정하여 공유 자원의 일관성을 보장하는 것
        
    - 한정적인 시스템 자원에 여러 스레드가 동시에 접근해서 사용하면 문제가 발생할 수 있다.
    - 이 문제를 방지하기 위해 **여러 스레드에게 하나의 자원에 대한 처리 권한을 주거나 순서를 조정**하는 기법.
- 동기화 문제와 데드락 관계
    
    동기화 문제와 데드락은 서로 밀접한 관계가 있습니다.
    
    동기화를 잘못 구현하면 데드락 문제가 발생할 수 있습니다. 데드락은 여러 스레드나 프로세스가 서로 상호작용하는 과정에서 일어나며, 동기화 문제와 마찬가지로 공유 자원에 대한 접근을 조율하는 과정에서 발생합니다. 예를 들어, 둘 이상의 스레드가 서로 다른 자원을 점유하고 있고, 서로가 점유한 자원을 요청하는 경우 데드락이 발생할 수 있습니다.
    
    또한, 동기화 문제와 데드락은 해결 방법에서도 밀접한 관계가 있습니다. 동기화 문제를 예방하고 해결하기 위한 기술들 중 일부는 데드락을 예방하고 해결하는 기술로도 사용됩니다. 예를 들어, 상호배제(Mutual exclusion) 조건을 해결하기 위해 경쟁 상황을 없애는 비선점 알고리즘을 사용하면 데드락을 예방할 수 있습니다. 또한, 데드락 탐지와 복구 기술들도 동기화 문제를 예방하는 데에 도움이 될 수 있습니다.
    
    따라서, 멀티스레드 프로그래밍에서는 동기화 문제와 데드락 문제를 함께 고려하여 적절한 동기화 기술을 사용하고, 데드락을 예방하고 해결하기 위한 기술을 적극적으로 활용해야 합니다.
    

## 데드락(Deadlock)

운영체제에서 데드락(교착상태)이란, 시스템 자원에 대한 요구가 뒤엉킨 상태입니다.

즉, **둘 이상의 프로세스가 다른 프로세스가 점유하고 있는 자원을 서로 기다릴 때 무한 대기에 빠지는 상황**을 일컫습니다.

### 데드락 발생 조건

1. 상호 배제(Mutual Exclusion) : 한 번에 프로세스 하나만 해당 자원을 사용할 수 있음. 다른 프로세스는 요청된 자원이 해제될 때까지 대기
    - 철학자가 젓가락 1개를 들고 있으면 다른 이는 그 젓가락을 사용할 수 없음
2. 점유 대기(Hold and Wait) : 자원을 가진 프로세스가 다른 자원을 기다릴 때 보유 자원을 놓지 않음
    - 철학자가 다른 한 쪽의 젓가락을 기다릴 때 들고 있는 젓가락을 놓지 않음
3. 비선점(No Preepmtion) : 한 프로세스가 자료를 사용하는 중에는 커널이 빼앗아서 다른 프로세스에 배분할 수 없음
    - 철학자가 집어든 젓가락은 다른 철학자가 빼앗을 수 없음
4. 원형 대기(Circular Wait) : 프로세스가 요구하는 자원의 방향이 사이클을 형성해야 함
    - 모든 철학자가 왼쪽 젓가락부터 집어드는 상황이라면 사이클을 형성하여 서로 점유한 자원을 요청하게 됨
- 위 4 가지 조건을 만족하더라도 드물게 발생한다.
    - 4가지가 성립해야만 비로소 교착상태의 발생확률이 존재
- 컴퓨터 환경에 치명적이고 교착상태에 의한 오류 해결이 힘든 편이다.

### 데드락의 해결법

1. 데드락이 발생하지 않도록 **예방**(Prevention)
2. 데드락 발생 가능성을 인정하고 적절히 **회피**(Avoidance)
3. 데드락 발생을 허용하나 데드락을 **탐지**(Detection)하여 **회복**(Recovery)

### 데드락 예방

- 교착상태 발생 조건 중 하나라도 발생하지 않게 하여 예방하는 방법
- 조건 중 하나 이상을 부정하여 방지할 수 있다.
    - 상호 배제 부정: 읽기 전용 공유 자원을 사용한다.
    - 점유 및 대기 부정: 프로세스가 실행되기 전 필요한 모든 자원을 할당(자원 낭비 발생)하거나 자원을 점유하고 있지 않을 때만 다른 자원을 요청할 수 있도록 한다.
        
        → 기아상태가 될 수 있다
        
        - 기아상태
            
            특정 프로세스의 우선순위가 낮아서 원하는 자원을 계속 할당 받지 못하는 상태를 말한다.
            
        - Deadlock vs Starvation
            - 교착상태 : 여러 프로세스가 동일 자원 점유를 요청할 때 발생
            - 기아상태 : 여러 프로세스가 부족한 자원을 점유하기 위해 경쟁할 때 발생
    - 비선점 부정: 모든 자원에 대해 선점을 허용한다 -> 자원 낭비가 발생한다.
    - 순환 대기 부정: 자원에 고유한 번호를 할당하고 번호 순서대로 자원을 요구하도록 한다.(자원 낭비 발생)
- 시스템의 처리량이나 효율성을 떨어뜨리고 비현실적이다.

### 데드락 회피

교착 상태가 발생하기 전에 안전한 상태에서만 자원 요청을 허용하는 방법

<img src=img/deadlock.png></img>

> 안전 상태 (Safe state): 교착상태를 발생시키지 않고 자원을 할당하는 순서 (safe sequence)가 존재해서 모든 프로세스가 정상적으로 종료할 수 있는 상태
> 

> 불안전 상태 (Unsafe state): 교착상태가 발생할 수 있는 상태
> 
- 다음과 같은 가정이 필요함
    - 프로세스 수가 고정되어 있어야 한다.
    - 자원의 종류와 수가 고정되어 있어야 한다.
    - 프로세스가 요구하는 자원 및 최대 자원의 수를 알아야 한다.
    - 프로세스는 반드시 자원을 사용 후 반납해야 한다.
- 자원 할당 그래프 (Resource-Allocation Graph) 알고리즘
    
    자원 인스턴스가 하나만 있는 경우 사용, 자원을 할당 받을 때 그래프에 사이클이 생기면 요청을 거부하는 방식
    
- 은행원 알고리즘 (Banker's Algorithm)
    
    자원 인스턴스가 여러개일 경우 사용, 자원 요청을 승인했을 때 안전한 상태가 유지되는 경우만 자원 할당, 불안전 상태가 예상되면 다른 프로세스가 끝날 때 까지 대기
    

 → 현실성이 부족하고 자원 요청이 있을 때마다 회피 알고리즘을 사용하는 것은 상당한 오버헤드다.

### 데드락 탐지 및 회복

- 주기적으로 교착상태가 발생했는 지 검사
- 주기가 짧으면 오버헤드가 커짐, 길면 복구 가능성 낮아짐
- 탐지 알고리즘
    - Single Instance의 경우 자원할당 그래프 활용
    - Multiple Instance의 경우 은행원 알고리즘 활용(Allocation, Request, Available)
- 회복 기법
    - process termination : 한 번에 모든 프로세스 혹은 한 개씩 종료
        - 한 번에 데드락이 걸린 모든 프로세스 중단 : 연산 중이던 프로세스도 모두 일시 중단되어 중간 결과가 폐기됨
        - 하나씩 중단시키며 탐지 알고리즘으로 데드락 탐지/회복 : 오버헤드 문제
    - resource Preemption(자원 선점) : 선점 비용이 최소인 victim 프로세스를 선택하여 자원을 빼앗음
    
    → 교착 상태를 일으킨 프로세스를 종료하거나 할당된 자원을 해제시키는 방법
    

### 데드락의 무시

- 교착상태 필요조건 4가지를 충족하더라도 데드락은 드문 현상임에 착안
- 드물게 발생하는 데드락을 처리하기 위한 비용은 비효율적이라 판단하여 데드락에 아무런 조치도 하지 않음.
- 시스템에서 데드락이 발생한 경우 프로그래머가 직접 process를 죽이는 행위로 대응
